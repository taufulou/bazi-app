"""
Bazi Constants — Heavenly Stems, Earthly Branches, Five Elements, Ten Gods, etc.
All lookup tables for deterministic Bazi calculation.
Mirrors the TypeScript constants in packages/shared/src/constants.ts
"""

from typing import Dict, List, Set, Tuple

# ============================================================
# Heavenly Stems (天干) — 10 Stems
# ============================================================

HEAVENLY_STEMS: List[str] = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸']
STEM_INDEX: Dict[str, int] = {s: i for i, s in enumerate(HEAVENLY_STEMS)}

# ============================================================
# Earthly Branches (地支) — 12 Branches
# ============================================================

EARTHLY_BRANCHES: List[str] = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥']
BRANCH_INDEX: Dict[str, int] = {b: i for i, b in enumerate(EARTHLY_BRANCHES)}

# ============================================================
# Five Elements (五行) Mappings
# ============================================================

STEM_ELEMENT: Dict[str, str] = {
    '甲': '木', '乙': '木',
    '丙': '火', '丁': '火',
    '戊': '土', '己': '土',
    '庚': '金', '辛': '金',
    '壬': '水', '癸': '水',
}

BRANCH_ELEMENT: Dict[str, str] = {
    '寅': '木', '卯': '木',
    '巳': '火', '午': '火',
    '辰': '土', '未': '土', '戌': '土', '丑': '土',
    '申': '金', '酉': '金',
    '子': '水', '亥': '水',
}

# Stem Yin/Yang: even index = 陽 (yang), odd index = 陰 (yin)
STEM_YINYANG: Dict[str, str] = {
    '甲': '陽', '乙': '陰',
    '丙': '陽', '丁': '陰',
    '戊': '陽', '己': '陰',
    '庚': '陽', '辛': '陰',
    '壬': '陽', '癸': '陰',
}

BRANCH_YINYANG: Dict[str, str] = {
    '子': '陽', '丑': '陰',
    '寅': '陽', '卯': '陰',
    '辰': '陽', '巳': '陰',
    '午': '陽', '未': '陰',
    '申': '陽', '酉': '陰',
    '戌': '陽', '亥': '陰',
}

# ============================================================
# Five Elements Cycles
# ============================================================

# 相生 (Production cycle): Wood→Fire→Earth→Metal→Water→Wood
ELEMENT_PRODUCES: Dict[str, str] = {
    '木': '火', '火': '土', '土': '金', '金': '水', '水': '木',
}

# 相剋 (Overcoming cycle): Wood→Earth→Water→Fire→Metal→Wood
ELEMENT_OVERCOMES: Dict[str, str] = {
    '木': '土', '土': '水', '水': '火', '火': '金', '金': '木',
}

# Reverse: which element is overcome by this element
ELEMENT_OVERCOME_BY: Dict[str, str] = {v: k for k, v in ELEMENT_OVERCOMES.items()}

# Reverse: which element produces this element
ELEMENT_PRODUCED_BY: Dict[str, str] = {v: k for k, v in ELEMENT_PRODUCES.items()}

FIVE_ELEMENTS: List[str] = ['木', '火', '土', '金', '水']
ELEMENT_INDEX: Dict[str, int] = {e: i for i, e in enumerate(FIVE_ELEMENTS)}

ELEMENT_ENGLISH: Dict[str, str] = {
    '木': 'wood', '火': 'fire', '土': 'earth', '金': 'metal', '水': 'water',
}

# ============================================================
# Hidden Stems (藏干)
# ============================================================

HIDDEN_STEMS: Dict[str, List[str]] = {
    '子': ['癸'],
    '丑': ['己', '癸', '辛'],
    '寅': ['甲', '丙', '戊'],
    '卯': ['乙'],
    '辰': ['戊', '乙', '癸'],
    '巳': ['丙', '庚', '戊'],
    '午': ['丁', '己'],
    '未': ['己', '丁', '乙'],
    '申': ['庚', '壬', '戊'],
    '酉': ['辛'],
    '戌': ['戊', '辛', '丁'],
    '亥': ['壬', '甲'],
}

# Hidden stem weights (本氣/中氣/餘氣 — Main/Secondary/Residual)
# Weights used for Five Elements balance calculation
HIDDEN_STEM_WEIGHTS: Dict[str, List[float]] = {
    '子': [1.0],
    '丑': [0.6, 0.2, 0.2],
    '寅': [0.6, 0.2, 0.2],
    '卯': [1.0],
    '辰': [0.6, 0.2, 0.2],
    '巳': [0.6, 0.2, 0.2],
    '午': [0.7, 0.3],
    '未': [0.6, 0.2, 0.2],
    '申': [0.6, 0.2, 0.2],
    '酉': [1.0],
    '戌': [0.6, 0.2, 0.2],
    '亥': [0.7, 0.3],
}

# ============================================================
# Ten Gods (十神) Derivation
# ============================================================

# Ten Gods are derived from the relationship between the Day Master and other stems.
# Relationship is based on:
# 1. Same element → 比肩 (same polarity) or 劫財 (different polarity)
# 2. I produce → 食神 (same polarity) or 傷官 (different polarity)
# 3. I overcome → 偏財 (same polarity) or 正財 (different polarity)
# 4. Overcomes me → 偏官 (same polarity) or 正官 (different polarity)
# 5. Produces me → 偏印 (same polarity) or 正印 (different polarity)

TEN_GODS_SAME_POLARITY: Dict[str, str] = {
    'same': '比肩',       # Companion (比肩)
    'i_produce': '食神',   # Eating God (食神)
    'i_overcome': '偏財',  # Indirect Wealth (偏財)
    'overcomes_me': '偏官', # Indirect Officer / Seven Killings (偏官/七殺)
    'produces_me': '偏印',  # Indirect Seal (偏印)
}

TEN_GODS_DIFF_POLARITY: Dict[str, str] = {
    'same': '劫財',       # Rob Wealth (劫財)
    'i_produce': '傷官',   # Hurting Officer (傷官)
    'i_overcome': '正財',  # Direct Wealth (正財)
    'overcomes_me': '正官', # Direct Officer (正官)
    'produces_me': '正印',  # Direct Seal (正印)
}

TEN_GODS_LIST: List[str] = [
    '比肩', '劫財', '食神', '傷官', '偏財', '正財', '偏官', '正官', '偏印', '正印',
]

TEN_GODS_ENGLISH: Dict[str, str] = {
    '比肩': 'Companion',
    '劫財': 'Rob Wealth',
    '食神': 'Eating God',
    '傷官': 'Hurting Officer',
    '偏財': 'Indirect Wealth',
    '正財': 'Direct Wealth',
    '偏官': 'Seven Killings',
    '正官': 'Direct Officer',
    '偏印': 'Indirect Seal',
    '正印': 'Direct Seal',
}

# ============================================================
# Na Yin (納音) — 60 Jiazi pairs mapped to element names
# ============================================================

NAYIN: Dict[str, str] = {
    '甲子': '海中金', '乙丑': '海中金',
    '丙寅': '爐中火', '丁卯': '爐中火',
    '戊辰': '大林木', '己巳': '大林木',
    '庚午': '路旁土', '辛未': '路旁土',
    '壬申': '劍鋒金', '癸酉': '劍鋒金',
    '甲戌': '山頭火', '乙亥': '山頭火',
    '丙子': '澗下水', '丁丑': '澗下水',
    '戊寅': '城頭土', '己卯': '城頭土',
    '庚辰': '白蠟金', '辛巳': '白蠟金',
    '壬午': '楊柳木', '癸未': '楊柳木',
    '甲申': '泉中水', '乙酉': '泉中水',
    '丙戌': '屋上土', '丁亥': '屋上土',
    '戊子': '霹靂火', '己丑': '霹靂火',
    '庚寅': '松柏木', '辛卯': '松柏木',
    '壬辰': '長流水', '癸巳': '長流水',
    '甲午': '沙中金', '乙未': '沙中金',
    '丙申': '山下火', '丁酉': '山下火',
    '戊戌': '平地木', '己亥': '平地木',
    '庚子': '壁上土', '辛丑': '壁上土',
    '壬寅': '金箔金', '癸卯': '金箔金',
    '甲辰': '覆燈火', '乙巳': '覆燈火',
    '丙午': '天河水', '丁未': '天河水',
    '戊申': '大驛土', '己酉': '大驛土',
    '庚戌': '釵釧金', '辛亥': '釵釧金',
    '壬子': '桑柘木', '癸丑': '桑柘木',
    '甲寅': '大溪水', '乙卯': '大溪水',
    '丙辰': '沙中土', '丁巳': '沙中土',
    '戊午': '天上火', '己未': '天上火',
    '庚申': '石榴木', '辛酉': '石榴木',
    '壬戌': '大海水', '癸亥': '大海水',
}

# ============================================================
# Twelve Life Stages (十二長生) for each element
# ============================================================

TWELVE_STAGES: List[str] = [
    '長生', '沐浴', '冠帶', '臨官', '帝旺', '衰',
    '病', '死', '墓', '絕', '胎', '養',
]

# Starting branch for each stem (陽干順行, 陰干逆行)
# Index in EARTHLY_BRANCHES where 長生 starts
STAGE_START: Dict[str, int] = {
    '甲': 10,  # 亥
    '乙': 4,   # 午 (reversed)
    '丙': 2,   # 寅
    '丁': 8,   # 酉 (reversed)
    '戊': 2,   # 寅
    '己': 8,   # 酉 (reversed)
    '庚': 5,   # 巳
    '辛': 0,   # 子 (reversed)
    '壬': 8,   # 申 → 猴 actually 申 is index 8? No. Let me recalculate.
    '癸': 2,   # 卯 (reversed) → actually 卯 is index 3
}

# Actually, let's use a proper mapping.
# For Yang stems (甲丙戊庚壬), stages go forward through branches.
# For Yin stems (乙丁己辛癸), stages go backward through branches.
# 長生 starting branch for each stem:
CHANGSHENG_BRANCH: Dict[str, str] = {
    '甲': '亥',  # Wood Yang: born in 亥 (Water)
    '乙': '午',  # Wood Yin: born in 午 (Fire)
    '丙': '寅',  # Fire Yang: born in 寅 (Wood)
    '丁': '酉',  # Fire Yin: born in 酉 (Metal)
    '戊': '寅',  # Earth Yang: born in 寅 (same as Fire)
    '己': '酉',  # Earth Yin: born in 酉 (same as Fire Yin)
    '庚': '巳',  # Metal Yang: born in 巳 (Fire)
    '辛': '子',  # Metal Yin: born in 子 (Water)
    '壬': '申',  # Water Yang: born in 申 (Metal)
    '癸': '卯',  # Water Yin: born in 卯 (Wood)
}

# ============================================================
# Shen Sha (神煞) — Special Stars
# ============================================================

# Tian Yi Noble (天乙貴人) — lookup by Day Stem
TIANYI_GUIREN: Dict[str, List[str]] = {
    '甲': ['丑', '未'],
    '乙': ['子', '申'],
    '丙': ['亥', '酉'],
    '丁': ['亥', '酉'],
    '戊': ['丑', '未'],
    '己': ['子', '申'],
    '庚': ['寅', '午'],  # Modern practice: "庚辛逢虎馬". Orthodox 《三命通會》: 庚→['丑','未']
    '辛': ['寅', '午'],
    '壬': ['卯', '巳'],
    '癸': ['卯', '巳'],
}

# Wen Chang (文昌) — Academic star, lookup by Day Stem
WENCHANG: Dict[str, str] = {
    '甲': '巳', '乙': '午', '丙': '申', '丁': '酉',
    '戊': '申', '己': '酉', '庚': '亥', '辛': '子',
    '壬': '寅', '癸': '卯',
}

# Yi Ma (驛馬) — Travel star, lookup by Day Branch
# Also called Relay Horse
YIMA: Dict[str, str] = {
    '申': '寅', '子': '寅', '辰': '寅',  # 申子辰 → 寅
    '寅': '申', '午': '申', '戌': '申',  # 寅午戌 → 申
    '巳': '亥', '酉': '亥', '丑': '亥',  # 巳酉丑 → 亥
    '亥': '巳', '卯': '巳', '未': '巳',  # 亥卯未 → 巳
}

# Tao Hua (桃花) — Peach Blossom / Romance star, lookup by Day Branch
TAOHUA: Dict[str, str] = {
    '申': '酉', '子': '酉', '辰': '酉',
    '寅': '卯', '午': '卯', '戌': '卯',
    '巳': '午', '酉': '午', '丑': '午',
    '亥': '子', '卯': '子', '未': '子',
}

# Hua Gai (華蓋) — Canopy star, lookup by Day Branch
HUAGAI: Dict[str, str] = {
    '申': '辰', '子': '辰', '辰': '辰',
    '寅': '戌', '午': '戌', '戌': '戌',
    '巳': '丑', '酉': '丑', '丑': '丑',
    '亥': '未', '卯': '未', '未': '未',
}

# Jiang Xing (將星) — General star, lookup by Day Branch
JIANGXING: Dict[str, str] = {
    '申': '子', '子': '子', '辰': '子',
    '寅': '午', '午': '午', '戌': '午',
    '巳': '酉', '酉': '酉', '丑': '酉',
    '亥': '卯', '卯': '卯', '未': '卯',
}

# Lu Shen (祿神) — Prosperity star, lookup by Day Stem
LUSHEN: Dict[str, str] = {
    '甲': '寅', '乙': '卯', '丙': '巳', '丁': '午',
    '戊': '巳', '己': '午', '庚': '申', '辛': '酉',
    '壬': '亥', '癸': '子',
}

# Yang Ren (羊刃) — Blade, lookup by Day Stem
YANGREN: Dict[str, str] = {
    '甲': '卯', '乙': '辰', '丙': '午', '丁': '未',
    '戊': '午', '己': '未', '庚': '酉', '辛': '戌',
    '壬': '子', '癸': '丑',
}

# Kong Wang (空亡) — Void, lookup by Day Pillar's Jiazi group
# Each group of 10 Jiazi pairs shares the same two void branches
# We compute void branches from the starting stem-branch pair of the Jiazi group

# ============================================================
# Phase 11D: Expanded Shen Sha (18 new types)
# ============================================================

# 紅鸞 (Hong Luan / Red Phoenix) — lookup by Year Branch
# 愛情桃花、婚姻機緣、感情吸引力
HONGLUAN: Dict[str, str] = {
    '子': '卯', '丑': '寅', '寅': '丑', '卯': '子',
    '辰': '亥', '巳': '戌', '午': '酉', '未': '申',
    '申': '未', '酉': '午', '戌': '巳', '亥': '辰',
}

# 天喜 (Tian Xi / Heavenly Joy) — 紅鸞對沖位, lookup by Year Branch
# 喜慶、正面事件、快樂場合
TIANXI: Dict[str, str] = {
    '子': '酉', '丑': '申', '寅': '未', '卯': '午',
    '辰': '巳', '巳': '辰', '午': '卯', '未': '寅',
    '申': '丑', '酉': '子', '戌': '亥', '亥': '戌',
}

# 天德貴人 (Tian De Gui Ren) — lookup by Month Branch, check pillar stems
# 消災解難、逢凶化吉、貴人保護
TIANDE: Dict[str, str] = {
    '寅': '丁', '卯': '申', '辰': '壬', '巳': '辛',
    '午': '亥', '未': '甲', '申': '癸', '酉': '寅',
    '戌': '丙', '亥': '乙', '子': '巳', '丑': '庚',
}

# 月德貴人 (Yue De Gui Ren) — lookup by Month Branch (三合化氣)
# 社交風度、和諧、家庭關係好
YUEDE: Dict[str, str] = {
    '寅': '丙', '午': '丙', '戌': '丙',
    '申': '壬', '子': '壬', '辰': '壬',
    '亥': '甲', '卯': '甲', '未': '甲',
    '巳': '庚', '酉': '庚', '丑': '庚',
}

# 太極貴人 (Tai Ji Gui Ren) — lookup by Day Stem
# 靈性智慧、哲學深度、神秘能力
TAIJI: Dict[str, List[str]] = {
    '甲': ['子', '午'], '乙': ['子', '午'],
    '丙': ['卯', '酉'], '丁': ['卯', '酉'],
    '戊': ['辰', '戌', '丑', '未'], '己': ['辰', '戌', '丑', '未'],
    '庚': ['寅', '亥'], '辛': ['寅', '亥'],
    '壬': ['巳', '申'], '癸': ['巳', '申'],
}

# 國印貴人 (Guo Yin Gui Ren) — lookup by Year Stem or Day Stem
# 政府職位、官方權威、行政能力
GUOYIN: Dict[str, str] = {
    '甲': '戌', '乙': '亥', '丙': '丑', '丁': '寅',
    '戊': '丑', '己': '寅', '庚': '辰', '辛': '巳',
    '壬': '未', '癸': '申',
}

# 金輿 (Jin Yu / Golden Carriage) — lookup by Day Stem
# 財富、車輛/交通、物質豐富
JINYU: Dict[str, str] = {
    '甲': '辰', '乙': '巳', '丙': '未', '丁': '申',
    '戊': '未', '己': '申', '庚': '戌', '辛': '亥',
    '壬': '丑', '癸': '寅',
}

# 天醫 (Tian Yi / Heavenly Doctor) — lookup by Month Branch
# 醫療才能、治癒能力、健康運。適合醫療/諮詢職業
TIANYI_DOCTOR: Dict[str, str] = {
    '寅': '丑', '卯': '寅', '辰': '卯', '巳': '辰',
    '午': '巳', '未': '午', '申': '未', '酉': '申',
    '戌': '酉', '亥': '戌', '子': '亥', '丑': '子',
}

# 學堂 (Xue Tang / Academy) — lookup by Day Stem (長生位)
# 教育、學習才能、研究能力、智力
XUETANG: Dict[str, str] = {
    '甲': '亥', '乙': '午', '丙': '寅', '丁': '酉',
    '戊': '寅', '己': '酉', '庚': '巳', '辛': '子',
    '壬': '申', '癸': '卯',
}

# 孤辰 (Gu Chen / Lonely Star) — lookup by Year Branch
# 孤獨（男性）、婚姻困難、人際關係薄弱
GUCHEN: Dict[str, str] = {
    '亥': '寅', '子': '寅', '丑': '寅',
    '寅': '巳', '卯': '巳', '辰': '巳',
    '巳': '申', '午': '申', '未': '申',
    '申': '亥', '酉': '亥', '戌': '亥',
}

# 寡宿 (Gua Su / Lonely Lodge) — lookup by Year Branch
# 孤獨（女性）、感情困難、獨處傾向
GUASU: Dict[str, str] = {
    '亥': '戌', '子': '戌', '丑': '戌',
    '寅': '丑', '卯': '丑', '辰': '丑',
    '巳': '辰', '午': '辰', '未': '辰',
    '申': '未', '酉': '未', '戌': '未',
}

# 災煞 (Zai Sha / Disaster Star) — lookup by Year Branch or Day Branch
# 意外、災難、不幸、傷害
ZAISHA: Dict[str, str] = {
    '申': '午', '子': '午', '辰': '午',
    '亥': '酉', '卯': '酉', '未': '酉',
    '寅': '子', '午': '子', '戌': '子',
    '巳': '卯', '酉': '卯', '丑': '卯',
}

# 劫煞 (Jie Sha / Robbery Star) — lookup by Year Branch or Day Branch
# 搶劫、盜竊、損失、財務傷害、背叛
JIESHA: Dict[str, str] = {
    '申': '巳', '子': '巳', '辰': '巳',
    '亥': '申', '卯': '申', '未': '申',
    '寅': '亥', '午': '亥', '戌': '亥',
    '巳': '寅', '酉': '寅', '丑': '寅',
}

# 亡神 (Wang Shen / Death God) — lookup by Year Branch or Day Branch
# 損失、死亡、消亡、衰敗、結束
WANGSHEN: Dict[str, str] = {
    '申': '亥', '子': '亥', '辰': '亥',
    '寅': '巳', '午': '巳', '戌': '巳',
    '巳': '申', '酉': '申', '丑': '申',
    '亥': '寅', '卯': '寅', '未': '寅',
}

# 天羅地網 (Tian Luo Di Wang / Sky Net & Earth Trap)
# 戌亥 = 天羅 (especially for 火命); 辰巳 = 地網 (especially for 水命)
TIANLUO_BRANCHES: Set[str] = {'戌', '亥'}
DIWANG_BRANCHES: Set[str] = {'辰', '巳'}

# ---- Day Pillar Special Combinations ----

# 魁罡日 (Kui Gang) — only check Day Pillar (stem+branch)
# 極端性格、全有或全無的命運、強大能量、領導力但婚姻摩擦
KUIGANG_DAYS: Set[str] = {'庚辰', '庚戌', '壬辰', '戊戌'}

# 陰陽差錯日 (Yin Yang Error Day) — only check Day Pillar
# 婚姻不和、離婚風險、夫妻冷淡、人生逆轉
YINYANG_ERROR_DAYS: Set[str] = {
    '丙子', '丁丑', '戊寅', '辛卯', '壬辰', '癸巳',
    '丙午', '丁未', '戊申', '辛酉', '壬戌', '癸亥',
}

# 十惡大敗日 (Shi E Da Bai) — only check Day Pillar
# 完全失敗、難以成功、貧困、不幸
# Corrected per 《三命通會》: 己丑 (NOT 乙丑)
SHIE_DABAI_DAYS: Set[str] = {
    '甲辰', '乙巳', '壬申', '丙申', '丁亥',
    '庚辰', '戊戌', '癸亥', '辛巳', '己丑',
}


# ============================================================
# Chinese Zodiac (生肖) by Year Branch
# ============================================================

ZODIAC: Dict[str, str] = {
    '子': '鼠', '丑': '牛', '寅': '虎', '卯': '兔',
    '辰': '龍', '巳': '蛇', '午': '馬', '未': '羊',
    '申': '猴', '酉': '雞', '戌': '狗', '亥': '豬',
}

# ============================================================
# Standard Meridians for Timezone Offsets
# ============================================================

# Standard meridian longitude for UTC offset hours
# UTC+X → standard meridian = X * 15 degrees East
TIMEZONE_MERIDIAN: Dict[float, float] = {
    -12.0: -180.0, -11.0: -165.0, -10.0: -150.0, -9.0: -135.0,
    -8.0: -120.0, -7.0: -105.0, -6.0: -90.0, -5.0: -75.0,
    -4.0: -60.0, -3.0: -45.0, -2.0: -30.0, -1.0: -15.0,
    0.0: 0.0, 1.0: 15.0, 2.0: 30.0, 3.0: 45.0,
    4.0: 60.0, 4.5: 67.5, 5.0: 75.0, 5.5: 82.5,
    5.75: 86.25, 6.0: 90.0, 6.5: 97.5, 7.0: 105.0,
    8.0: 120.0, 8.75: 131.25, 9.0: 135.0, 9.5: 142.5,
    10.0: 150.0, 10.5: 157.5, 11.0: 165.0, 12.0: 180.0,
    12.75: 191.25, 13.0: 195.0,
}

# ============================================================
# Major City Coordinates for common birth locations
# ============================================================

CITY_COORDINATES: Dict[str, Tuple[float, float]] = {
    # ---- Taiwan (22 administrative divisions) ----
    # 6 Special Municipalities
    '台北': (121.5654, 25.0330),
    '台北市': (121.5654, 25.0330),
    'Taipei': (121.5654, 25.0330),
    '新北': (121.4628, 25.0120),
    '新北市': (121.4628, 25.0120),
    '桃園': (121.3010, 24.9936),
    '桃園市': (121.3010, 24.9936),
    '台中': (120.6736, 24.1477),
    '台中市': (120.6736, 24.1477),
    '台南': (120.2270, 22.9999),
    '台南市': (120.2270, 22.9999),
    '高雄': (120.3014, 22.6273),
    '高雄市': (120.3014, 22.6273),
    # 3 Provincial Cities
    '新竹': (120.9647, 24.8138),
    '新竹市': (120.9647, 24.8138),
    '基隆': (121.7419, 25.1276),
    '基隆市': (121.7419, 25.1276),
    '嘉義': (120.4491, 23.4800),
    '嘉義市': (120.4491, 23.4800),
    # County seats
    '宜蘭': (121.7530, 24.7570),
    '宜蘭市': (121.7530, 24.7570),
    'Yilan': (121.7530, 24.7570),
    '竹北': (121.0042, 24.8396),
    '竹北市': (121.0042, 24.8396),
    'Zhubei': (121.0042, 24.8396),
    '苗栗': (120.8214, 24.5602),
    '苗栗市': (120.8214, 24.5602),
    'Miaoli': (120.8214, 24.5602),
    '彰化': (120.5382, 24.0734),
    '彰化市': (120.5382, 24.0734),
    'Changhua': (120.5382, 24.0734),
    '南投': (120.6837, 23.9099),
    '南投市': (120.6837, 23.9099),
    'Nantou': (120.6837, 23.9099),
    '斗六': (120.5275, 23.7075),
    '斗六市': (120.5275, 23.7075),
    'Douliu': (120.5275, 23.7075),
    '太保': (120.4327, 23.4596),
    '太保市': (120.4327, 23.4596),
    'Taibao': (120.4327, 23.4596),
    '花蓮': (121.6014, 23.9871),
    '花蓮市': (121.6014, 23.9871),
    '屏東': (120.4876, 22.6727),
    '屏東市': (120.4876, 22.6727),
    '台東': (121.1460, 22.7583),
    '台東市': (121.1460, 22.7583),
    'Taitung': (121.1460, 22.7583),
    '馬公': (119.5667, 23.5666),
    '馬公市': (119.5667, 23.5666),
    '澎湖': (119.5667, 23.5666),
    'Magong': (119.5667, 23.5666),
    '金門': (118.3177, 24.4364),
    '金城鎮': (118.3177, 24.4364),
    'Kinmen': (118.3177, 24.4364),
    'Jincheng': (118.3177, 24.4364),
    '馬祖': (119.9440, 26.1508),
    '南竿鄉': (119.9440, 26.1508),
    'Matsu': (119.9440, 26.1508),
    'Nangan': (119.9440, 26.1508),
    # ---- Hong Kong & Macau ----
    '香港': (114.1694, 22.3193),
    'Hong Kong': (114.1694, 22.3193),
    '九龍': (114.1840, 22.3380),
    'Kowloon': (114.1840, 22.3380),
    '澳門': (113.5439, 22.1987),
    'Macau': (113.5439, 22.1987),
    # ---- Malaysia ----
    # Federal Territories
    '吉隆坡': (101.6869, 3.1390),
    'Kuala Lumpur': (101.6869, 3.1390),
    '布城': (101.6964, 2.9264),
    'Putrajaya': (101.6964, 2.9264),
    # Peninsular states (州屬) — state capital coords, max ~8 min TST error
    '雪蘭莪': (101.5325, 3.0738),
    'Selangor': (101.5325, 3.0738),
    '莎阿南': (101.5325, 3.0738),
    'Shah Alam': (101.5325, 3.0738),
    '八打靈再也': (101.5325, 3.0738),
    'Petaling Jaya': (101.5325, 3.0738),
    '梳邦再也': (101.5325, 3.0738),
    'Subang Jaya': (101.5325, 3.0738),
    '檳城': (100.3293, 5.4164),
    'Penang': (100.3293, 5.4164),
    'Pulau Pinang': (100.3293, 5.4164),
    '柔佛': (103.7414, 1.4927),
    'Johor': (103.7414, 1.4927),
    '新山': (103.7414, 1.4927),
    'Johor Bahru': (103.7414, 1.4927),
    '霹靂': (101.0901, 4.5975),
    'Perak': (101.0901, 4.5975),
    '怡保': (101.0901, 4.5975),
    'Ipoh': (101.0901, 4.5975),
    '森美蘭': (101.9424, 2.7258),
    'Negeri Sembilan': (101.9424, 2.7258),
    '芙蓉': (101.9424, 2.7258),
    'Seremban': (101.9424, 2.7258),
    '馬六甲': (102.2501, 2.1896),
    'Melaka': (102.2501, 2.1896),
    'Malacca': (102.2501, 2.1896),
    '彭亨': (103.4174, 3.8077),
    'Pahang': (103.4174, 3.8077),
    '關丹': (103.4174, 3.8077),
    'Kuantan': (103.4174, 3.8077),
    '登嘉樓': (103.1324, 5.3117),
    'Terengganu': (103.1324, 5.3117),
    '瓜拉登嘉樓': (103.1324, 5.3117),
    'Kuala Terengganu': (103.1324, 5.3117),
    '吉蘭丹': (102.2386, 6.1256),
    'Kelantan': (102.2386, 6.1256),
    '哥打巴魯': (102.2386, 6.1256),
    'Kota Bharu': (102.2386, 6.1256),
    '吉打': (100.3685, 6.1248),
    'Kedah': (100.3685, 6.1248),
    '亞羅士打': (100.3685, 6.1248),
    'Alor Setar': (100.3685, 6.1248),
    '玻璃市': (100.1953, 6.4414),
    'Perlis': (100.1953, 6.4414),
    '加央': (100.1953, 6.4414),
    'Kangar': (100.1953, 6.4414),
    # East Malaysia (Borneo)
    '古晉': (110.3444, 1.5497),
    'Kuching': (110.3444, 1.5497),
    '亞庇': (116.0735, 5.9804),
    'Kota Kinabalu': (116.0735, 5.9804),
    '詩巫': (111.8311, 2.3000),
    'Sibu': (111.8311, 2.3000),
    '美里': (114.0127, 4.3995),
    'Miri': (114.0127, 4.3995),
    '山打根': (118.0669, 5.8402),
    'Sandakan': (118.0669, 5.8402),
    '納閩': (115.2308, 5.2831),
    'Labuan': (115.2308, 5.2831),
    # ---- China (47 major cities) ----
    # Tier 1
    '北京': (116.4074, 39.9042),
    'Beijing': (116.4074, 39.9042),
    '上海': (121.4737, 31.2304),
    'Shanghai': (121.4737, 31.2304),
    '廣州': (113.2644, 23.1291),
    '广州': (113.2644, 23.1291),
    'Guangzhou': (113.2644, 23.1291),
    '深圳': (114.0579, 22.5431),
    'Shenzhen': (114.0579, 22.5431),
    # Tier 1.5
    '成都': (104.0665, 30.5728),
    'Chengdu': (104.0665, 30.5728),
    '重慶': (106.5516, 29.5630),
    '重庆': (106.5516, 29.5630),
    'Chongqing': (106.5516, 29.5630),
    '杭州': (120.1551, 30.2741),
    'Hangzhou': (120.1551, 30.2741),
    '南京': (118.7969, 32.0603),
    'Nanjing': (118.7969, 32.0603),
    '武漢': (114.3055, 30.5928),
    '武汉': (114.3055, 30.5928),
    'Wuhan': (114.3055, 30.5928),
    '西安': (108.9402, 34.2583),
    "Xi'an": (108.9402, 34.2583),
    '天津': (117.1901, 39.1255),
    'Tianjin': (117.1901, 39.1255),
    '長沙': (112.9388, 28.2282),
    '长沙': (112.9388, 28.2282),
    'Changsha': (112.9388, 28.2282),
    '蘇州': (120.6199, 31.2990),
    '苏州': (120.6199, 31.2990),
    'Suzhou': (120.6199, 31.2990),
    '東莞': (113.7518, 23.0209),
    '东莞': (113.7518, 23.0209),
    'Dongguan': (113.7518, 23.0209),
    '鄭州': (113.6254, 34.7466),
    '郑州': (113.6254, 34.7466),
    'Zhengzhou': (113.6254, 34.7466),
    '瀋陽': (123.4315, 41.8057),
    '沈阳': (123.4315, 41.8057),
    'Shenyang': (123.4315, 41.8057),
    '青島': (120.3826, 36.0671),
    '青岛': (120.3826, 36.0671),
    'Qingdao': (120.3826, 36.0671),
    '寧波': (121.5440, 29.8683),
    '宁波': (121.5440, 29.8683),
    'Ningbo': (121.5440, 29.8683),
    '佛山': (113.1215, 23.0218),
    'Foshan': (113.1215, 23.0218),
    '大連': (121.6147, 38.9140),
    '大连': (121.6147, 38.9140),
    'Dalian': (121.6147, 38.9140),
    '哈爾濱': (126.6425, 45.7567),
    '哈尔滨': (126.6425, 45.7567),
    'Harbin': (126.6425, 45.7567),
    '濟南': (117.0009, 36.6512),
    '济南': (117.0009, 36.6512),
    'Jinan': (117.0009, 36.6512),
    '昆明': (102.8329, 25.0389),
    'Kunming': (102.8329, 25.0389),
    '合肥': (117.2272, 31.8206),
    'Hefei': (117.2272, 31.8206),
    '無錫': (120.3119, 31.4912),
    '无锡': (120.3119, 31.4912),
    'Wuxi': (120.3119, 31.4912),
    # Tier 2
    '廈門': (118.0894, 24.4798),
    '厦门': (118.0894, 24.4798),
    'Xiamen': (118.0894, 24.4798),
    '福州': (119.2965, 26.0745),
    'Fuzhou': (119.2965, 26.0745),
    '長春': (125.3235, 43.8171),
    '长春': (125.3235, 43.8171),
    'Changchun': (125.3235, 43.8171),
    '石家莊': (114.5149, 38.0428),
    '石家庄': (114.5149, 38.0428),
    'Shijiazhuang': (114.5149, 38.0428),
    '貴陽': (106.6302, 26.6477),
    '贵阳': (106.6302, 26.6477),
    'Guiyang': (106.6302, 26.6477),
    '溫州': (120.6994, 28.0006),
    '温州': (120.6994, 28.0006),
    'Wenzhou': (120.6994, 28.0006),
    '南寧': (108.3661, 22.8170),
    '南宁': (108.3661, 22.8170),
    'Nanning': (108.3661, 22.8170),
    '太原': (112.5489, 37.8706),
    'Taiyuan': (112.5489, 37.8706),
    '南昌': (115.8581, 28.6820),
    'Nanchang': (115.8581, 28.6820),
    '常州': (119.9741, 31.8118),
    'Changzhou': (119.9741, 31.8118),
    '煙台': (121.3917, 37.5399),
    '烟台': (121.3917, 37.5399),
    'Yantai': (121.3917, 37.5399),
    '蘭州': (103.8343, 36.0611),
    '兰州': (103.8343, 36.0611),
    'Lanzhou': (103.8343, 36.0611),
    '珠海': (113.5767, 22.2710),
    'Zhuhai': (113.5767, 22.2710),
    '惠州': (114.4160, 23.1116),
    'Huizhou': (114.4160, 23.1116),
    '中山': (113.3926, 22.5176),
    'Zhongshan': (113.3926, 22.5176),
    '海口': (110.3500, 20.0440),
    'Haikou': (110.3500, 20.0440),
    '汕頭': (116.6815, 23.3535),
    '汕头': (116.6815, 23.3535),
    'Shantou': (116.6815, 23.3535),
    # Western China & autonomous regions
    '烏魯木齊': (87.6168, 43.8256),
    '乌鲁木齐': (87.6168, 43.8256),
    'Urumqi': (87.6168, 43.8256),
    '拉薩': (91.1320, 29.6600),
    '拉萨': (91.1320, 29.6600),
    'Lhasa': (91.1320, 29.6600),
    '呼和浩特': (111.7517, 40.8426),
    'Hohhot': (111.7517, 40.8426),
    '銀川': (106.2782, 38.4872),
    '银川': (106.2782, 38.4872),
    'Yinchuan': (106.2782, 38.4872),
    '西寧': (101.7782, 36.6171),
    '西宁': (101.7782, 36.6171),
    'Xining': (101.7782, 36.6171),
    # ---- Singapore ----
    '新加坡': (103.8198, 1.3521),
    'Singapore': (103.8198, 1.3521),
    # ---- Japan & Korea ----
    '東京': (139.6917, 35.6895),
    'Tokyo': (139.6917, 35.6895),
    '大阪': (135.5023, 34.6937),
    'Osaka': (135.5023, 34.6937),
    '首爾': (126.9780, 37.5665),
    'Seoul': (126.9780, 37.5665),
    # ---- Southeast Asia ----
    '曼谷': (100.5018, 13.7563),
    'Bangkok': (100.5018, 13.7563),
    '胡志明市': (106.6297, 10.8231),
    'Ho Chi Minh City': (106.6297, 10.8231),
    '雅加達': (106.8456, -6.2088),
    'Jakarta': (106.8456, -6.2088),
    '馬尼拉': (120.9842, 14.5995),
    'Manila': (120.9842, 14.5995),
    '仰光': (96.1951, 16.8661),
    'Yangon': (96.1951, 16.8661),
    # ---- South Asia ----
    '新德里': (77.2090, 28.6139),
    'New Delhi': (77.2090, 28.6139),
    '孟買': (72.8777, 19.0760),
    'Mumbai': (72.8777, 19.0760),
    '可倫坡': (79.8612, 6.9271),
    'Colombo': (79.8612, 6.9271),
    # ---- Australia ----
    '雪梨': (151.2093, -33.8688),
    'Sydney': (151.2093, -33.8688),
    '墨爾本': (144.9631, -37.8136),
    'Melbourne': (144.9631, -37.8136),
    '布里斯本': (153.0251, -27.4698),
    'Brisbane': (153.0251, -27.4698),
    '伯斯': (115.8605, -31.9505),
    'Perth': (115.8605, -31.9505),
    # ---- Americas ----
    '紐約': (-74.0060, 40.7128),
    'New York': (-74.0060, 40.7128),
    '洛杉磯': (-118.2437, 34.0522),
    'Los Angeles': (-118.2437, 34.0522),
    '舊金山': (-122.4194, 37.7749),
    'San Francisco': (-122.4194, 37.7749),
    '多倫多': (-79.3832, 43.6532),
    'Toronto': (-79.3832, 43.6532),
    '溫哥華': (-123.1216, 49.2827),
    'Vancouver': (-123.1216, 49.2827),
    # ---- Europe ----
    '倫敦': (-0.1276, 51.5074),
    'London': (-0.1276, 51.5074),
    '巴黎': (2.3522, 48.8566),
    'Paris': (2.3522, 48.8566),
    '柏林': (13.4050, 52.5200),
    'Berlin': (13.4050, 52.5200),
}

# ============================================================
# Pattern Types (格局) — major Bazi patterns
# ============================================================

PATTERN_TYPES: Dict[str, str] = {
    '比肩': '比肩格',
    '劫財': '劫財格',
    '食神': '食神格',
    '傷官': '傷官格',
    '偏財': '偏財格',
    '正財': '正財格',
    '偏官': '偏官格',
    '正官': '正官格',
    '偏印': '偏印格',
    '正印': '正印格',
}

# ============================================================
# Season Strength (月令旺衰) — Stem strength by Month Branch
# ============================================================

# Which element is prosperous (旺) in which month branch
MONTH_PROSPEROUS_ELEMENT: Dict[str, str] = {
    '寅': '木', '卯': '木',       # Spring → Wood prospers
    '巳': '火', '午': '火',       # Summer → Fire prospers
    '申': '金', '酉': '金',       # Autumn → Metal prospers
    '亥': '水', '子': '水',       # Winter → Water prospers
    '辰': '土', '未': '土', '戌': '土', '丑': '土',  # Earth months
}

# Day Master strength score by month — 旺相休囚死 (Five Qi States)
# Source: 《子平真詮·論旺相休囚死》, 百度百科, 三命通會卷二
# Rules: 当令者旺(5), 令生者相(4), 生令者休(3), 克令者囚(2), 令克者死(1)
# Seasons: Spring(寅卯)=木, Summer(巳午)=火, Earth(辰未戌丑)=土, Autumn(申酉)=金, Winter(亥子)=水
# Each column sums to 15 (one element per qi state per season)
SEASON_STRENGTH: Dict[str, Dict[str, int]] = {
    #           寅(木) 卯(木) 辰(土) 巳(火) 午(火) 未(土) 申(金) 酉(金) 戌(土) 亥(水) 子(水) 丑(土)
    '木': {'寅': 5, '卯': 5, '辰': 2, '巳': 3, '午': 3, '未': 2, '申': 1, '酉': 1, '戌': 2, '亥': 4, '子': 4, '丑': 2},
    '火': {'寅': 4, '卯': 4, '辰': 3, '巳': 5, '午': 5, '未': 3, '申': 2, '酉': 2, '戌': 3, '亥': 1, '子': 1, '丑': 3},
    '土': {'寅': 1, '卯': 1, '辰': 5, '巳': 4, '午': 4, '未': 5, '申': 3, '酉': 3, '戌': 5, '亥': 2, '子': 2, '丑': 5},
    '金': {'寅': 2, '卯': 2, '辰': 4, '巳': 1, '午': 1, '未': 4, '申': 5, '酉': 5, '戌': 4, '亥': 3, '子': 3, '丑': 4},
    '水': {'寅': 3, '卯': 3, '辰': 1, '巳': 2, '午': 2, '未': 1, '申': 4, '酉': 4, '戌': 1, '亥': 5, '子': 5, '丑': 1},
}

# ============================================================
# Hour Branch Time Ranges (using True Solar Time)
# ============================================================

# Each branch covers a 2-hour period
HOUR_BRANCHES: List[Tuple[int, int, str]] = [
    (23, 1, '子'),   # 23:00 - 00:59
    (1, 3, '丑'),    # 01:00 - 02:59
    (3, 5, '寅'),    # 03:00 - 04:59
    (5, 7, '卯'),    # 05:00 - 06:59
    (7, 9, '辰'),    # 07:00 - 08:59
    (9, 11, '巳'),   # 09:00 - 10:59
    (11, 13, '午'),  # 11:00 - 12:59
    (13, 15, '未'),  # 13:00 - 14:59
    (15, 17, '申'),  # 15:00 - 16:59
    (17, 19, '酉'),  # 17:00 - 18:59
    (19, 21, '戌'),  # 19:00 - 20:59
    (21, 23, '亥'),  # 21:00 - 22:59
]

# Stem for each hour, based on Day Stem
# Day Stem index (0-9) → first hour stem index
DAY_STEM_TO_HOUR_STEM_START: Dict[int, int] = {
    0: 0,  # 甲/己 day → 甲子時 start
    1: 2,  # 乙/庚 day → 丙子時 start
    2: 4,  # 丙/辛 day → 戊子時 start
    3: 6,  # 丁/壬 day → 庚子時 start
    4: 8,  # 戊/癸 day → 壬子時 start
    5: 0,  # 己/甲 → same as 甲
    6: 2,  # 庚/乙 → same as 乙
    7: 4,  # 辛/丙 → same as 丙
    8: 6,  # 壬/丁 → same as 丁
    9: 8,  # 癸/戊 → same as 戊
}

# ============================================================
# Solar Terms (節氣) — 24 solar terms for month boundary
# ============================================================

# The 12 "major" solar terms (節) that define month boundaries in Bazi
# These are the ODD-numbered solar terms in the full 24 cycle
MONTH_DEFINING_TERMS: List[str] = [
    '立春',  # Start of Spring → Month 1 (寅)
    '驚蟄',  # Awakening of Insects → Month 2 (卯)
    '清明',  # Clear and Bright → Month 3 (辰)
    '立夏',  # Start of Summer → Month 4 (巳)
    '芒種',  # Grain in Ear → Month 5 (午)
    '小暑',  # Slight Heat → Month 6 (未)
    '立秋',  # Start of Autumn → Month 7 (申)
    '白露',  # White Dew → Month 8 (酉)
    '寒露',  # Cold Dew → Month 9 (戌)
    '立冬',  # Start of Winter → Month 10 (亥)
    '大雪',  # Heavy Snow → Month 11 (子)
    '小寒',  # Slight Cold → Month 12 (丑)
]

# Month branch sequence starting from 寅 (month 1)
MONTH_BRANCHES: List[str] = ['寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥', '子', '丑']

# Year Stem → Month 1 (寅) Stem mapping
# 甲己年 → 丙寅月, 乙庚年 → 戊寅月, 丙辛年 → 庚寅月, 丁壬年 → 壬寅月, 戊癸年 → 甲寅月
YEAR_STEM_TO_MONTH_STEM_START: Dict[int, int] = {
    0: 2,  # 甲 → 丙 (index 2)
    1: 4,  # 乙 → 戊 (index 4)
    2: 6,  # 丙 → 庚 (index 6)
    3: 8,  # 丁 → 壬 (index 8)
    4: 0,  # 戊 → 甲 (index 0)
    5: 2,  # 己 → 丙
    6: 4,  # 庚 → 戊
    7: 6,  # 辛 → 庚
    8: 8,  # 壬 → 壬
    9: 0,  # 癸 → 甲
}
